version: '3'

tasks:
  # ---------------------------------------------------------------------------
  # ğŸ‘©â€ğŸ’»  æ—¥å¸¸é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã¨ãƒ•ã‚¡ã‚¤ãƒ«åŒæœŸï¼‰
  # ---------------------------------------------------------------------------
  up:
    desc: Start dev stack with Compose Watch (bind-mount + reload)
    cmds:
      - docker compose up -d
    sources:
      - app/**/**/*

  stop:
    desc: Stop dev stack and remove volumes/orphans
    cmds:
      - docker compose down --volumes --remove-orphans

  down:
    desc: Stop dev stack and remove volumes/orphans
    cmds:
      - docker compose down --volumes --remove-orphans

  restart:
    desc: Restart dev stack
    cmds:
      - docker compose restart

  ps:
    desc: Show dev stack status
    cmds:
      - docker compose ps

  # ---------------------------------------------------------------------------
  # ğŸ§ª  æœ¬ç•ªç’°å¢ƒã«è¿‘ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ãŸãƒ­ãƒ¼ã‚«ãƒ«çµ±åˆ/E2Eãƒ†ã‚¹ãƒˆ
  # ---------------------------------------------------------------------------
  test:
    desc: Spin up stack â†’ run tests â†’ tear down
    cmds:
      - docker compose up -d
      - docker compose exec backend uv run pytest tests -v --cov=src --cov-report=term
      - docker compose down --volumes --remove-orphans

  # ---------------------------------------------------------------------------
  # ğŸŒ  Azure Container Apps / App Serviceã¸ã®æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤
  # ---------------------------------------------------------------------------
  deploy:
    desc: Update ACA with new image tags
    cmds:
      - az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
      - az acr login --name $ACR_NAME
      - |
        az containerapp update --name backend-prod \
          --image $ACR_URL/backend:${TAG} \
          --resource-group $RESOURCE_GROUP
      - |
        az containerapp update --name console-prod \
          --image $ACR_URL/console:${TAG} \
          --resource-group $RESOURCE_GROUP
    env:
      TAG: latest
    requires:
      vars: [AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, AZURE_TENANT_ID, ACR_NAME, ACR_URL, RESOURCE_GROUP]

  # ---------------------------------------------------------------------------
  # ğŸ§¹  ãƒã‚¦ã‚¹ã‚­ãƒ¼ãƒ”ãƒ³ã‚°ï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä½œæ¥­ï¼‰
  # ---------------------------------------------------------------------------
  prune:
    desc: Clean dangling Docker resources
    cmds:
      - docker system prune -f
